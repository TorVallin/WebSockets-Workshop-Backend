<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Application</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <!-- Toastify.css -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

    <style>
        :root {
            --primary-purple: #280071;
            --light-purple: #3d1a8b;
            --lighter-purple: #5c2eb7;
            --dark-bg: #1a1a1a;
            --darker-bg: #0f0f0f;
            --text-light: #e0e0e0;
            --text-muted: #b0b0b0;
            --orange-brown: #b76d2e;
            --dark-red: #8b1a1a;
        }

        body {
            background: linear-gradient(135deg, var(--dark-bg) 0%, var(--primary-purple) 100%);
            color: var(--text-light);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            margin: 0;
            padding: 0;
        }

        .chat-container {
            height: 100vh;
            display: flex;
            flex-direction: row;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            position: relative;
        }

        /* Members Sidebar */
        .members-sidebar {
            width: 280px;
            min-width: 280px;
            background: rgba(0, 0, 0, 0.5);
            border-right: 2px solid var(--light-purple);
            display: flex;
            flex-direction: column;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            position: absolute;
            height: 100vh;
            z-index: 1000;
            backdrop-filter: blur(15px);
        }

        .members-sidebar.show {
            transform: translateX(0);
        }

        .sidebar-header {
            background: var(--primary-purple);
            padding: 1rem;
            border-bottom: 1px solid var(--light-purple);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-header h5 {
            color: white;
            margin: 0;
            flex: 1;
            font-weight: 600;
        }

        .btn-close-sidebar {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            padding: 0;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            transition: background 0.3s ease;
        }

        .btn-close-sidebar:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .rooms-section {
            border-bottom: 1px solid var(--light-purple);
            padding: 0.5rem;
        }

        .rooms-section-header {
            padding: 0.5rem 1rem;
            color: var(--text-muted);
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn-create-room {
            background: var(--lighter-purple);
            border: none;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 5px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .btn-create-room:hover {
            background: var(--primary-purple);
        }

        .rooms-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .room-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            margin: 0.25rem 0;
            border-radius: 10px;
            background: rgba(40, 0, 113, 0.2);
            color: var(--text-light);
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .room-item:hover {
            background: rgba(40, 0, 113, 0.4);
            transform: translateX(5px);
        }

        .room-item.active {
            background: var(--primary-purple);
            border-color: var(--lighter-purple);
        }

        .room-item i {
            margin-right: 0.5rem;
            font-size: 1.1rem;
        }

        .room-item .room-name {
            flex: 1;
        }

        .members-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .member-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            margin: 0.25rem 0;
            border-radius: 10px;
            background: rgba(40, 0, 113, 0.2);
            color: var(--text-light);
            transition: background 0.3s ease;
        }

        .member-item:hover {
            background: rgba(40, 0, 113, 0.4);
        }

        .member-item span:first-of-type {
            flex: 1;
            margin-left: 0.5rem;
        }

        .member-status {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-weight: 500;
        }

        .member-status.online {
            background: #00ff88;
            color: #000;
        }

        .member-status.typing {
            background: var(--lighter-purple);
            color: white;
            animation: pulse 1s infinite;
        }

        .member-status.away {
            background: #ffaa00;
            color: #000;
        }

        /* Main Chat Area */
        .main-chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            transition: margin-left 0.3s ease;
        }

        .members-sidebar.show ~ .main-chat-area {
            margin-left: 280px;
        }

        .chat-header {
            background: var(--primary-purple);
            border-bottom: 2px solid var(--light-purple);
            padding: 1rem;
            box-shadow: 0 2px 10px rgba(40, 0, 113, 0.3);
        }

        .chat-header h3 {
            margin: 0;
            color: white;
            font-weight: 600;
        }

        .room-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(255, 255, 255, 0.1);
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            margin-left: 1rem;
        }

        .room-indicator i {
            color: var(--lighter-purple);
        }

        .clear-chat-btn {
            background: var(--dark-red);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-left: 1rem;
        }

        .clear-chat-btn:hover {
            background: #a61e1e;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .online-indicator {
            width: 10px;
            height: 10px;
            background: #00ff88;
            border-radius: 50%;
            display: inline-block;
            margin-left: 10px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.2);
        }

        .message {
            margin-bottom: 1rem;
            animation: fadeInUp 0.3s ease-out;
        }

        .message-own {
            text-align: right;
        }

        .message-bubble {
            display: inline-block;
            max-width: 70%;
            padding: 0.75rem 1rem;
            border-radius: 20px;
            word-wrap: break-word;
            overflow-wrap: anywhere;
        }

        .message-bubble.own {
            background: var(--primary-purple);
            color: white;
            border-bottom-right-radius: 5px;
        }

        .message-bubble.other {
            background: var(--darker-bg);
            color: var(--text-light);
            border: 1px solid var(--light-purple);
            border-bottom-left-radius: 5px;
        }

        .message-info {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .system-message {
            text-align: center;
            margin: 1rem 0;
            padding: 0.5rem;
            background: rgba(40, 0, 113, 0.2);
            border-radius: 10px;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .typing-indicator {
            display: flex;
            justify-content: center;
            padding: 0.75rem;
            margin: 0.5rem 0;
        }

        .typing-indicator span {
            height: 10px;
            width: 10px;
            background: var(--lighter-purple);
            border-radius: 50%;
            display: inline-block;
            margin: 0 3px;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-indicator span:nth-child(1) {
            animation-delay: 0s;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }

        /* Typing Indicator Above Input */
        .typing-indicator-container {
            background: rgba(40, 0, 113, 0.3);
            border-top: 1px solid var(--light-purple);
            padding: 0.75rem 1rem;
            min-height: 45px;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .typing-indicator-container.hidden {
            display: none;
        }

        .typing-indicator-container .typing-text {
            color: var(--lighter-purple);
            font-size: 0.9rem;
            font-style: italic;
            flex: 1;
        }

        .typing-dots {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-left: 8px;
        }

        .typing-dots span {
            width: 6px;
            height: 6px;
            background: var(--lighter-purple);
            border-radius: 50%;
            display: inline-block;
            animation: typingDot 1.4s infinite ease-in-out;
        }

        .typing-dots span:nth-child(1) {
            animation-delay: 0s;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingDot {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.7;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        /* Input Container */
        .chat-input-container {
            background: var(--darker-bg);
            border-top: 2px solid var(--light-purple);
            padding: 1rem;
        }

        .chat-input-container .input-group {
            background: rgba(40, 0, 113, 0.2);
            border-radius: 25px;
            overflow: hidden;
        }

        .chat-input-container .form-control {
            background: transparent;
            border: none;
            color: var(--text-light);
            padding: 0.75rem 1rem;
        }

        .chat-input-container .form-control:focus {
            background: transparent;
            color: var(--text-light);
            box-shadow: none;
        }

        .chat-input-container .form-control::placeholder {
            color: var(--text-muted);
        }

        .btn-send {
            background: var(--primary-purple);
            border: none;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0 25px 25px 0;
            transition: background 0.3s ease;
        }

        .btn-send:hover {
            background: var(--light-purple);
            color: white;
        }

        .btn-send:active {
            background: var(--lighter-purple) !important;
        }

        .btn-toggle {
            background: rgba(40, 0, 113, 0.3);
            border: 1px solid var(--light-purple);
            color: white;
            padding: 0.5rem;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        .btn-toggle:hover {
            background: var(--light-purple);
            transform: scale(1.1);
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .members-sidebar {
                width: 100%;
                max-width: 300px;
            }

            .message-bubble {
                max-width: 85%;
            }

            .typing-indicator-container {
                position: sticky;
                bottom: 70px;
                z-index: 100;
                background: rgba(40, 0, 113, 0.95);
                backdrop-filter: blur(15px);
                box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.3);
            }
        }

        /* Scrollbar Styling */
        .chat-messages::-webkit-scrollbar,
        .members-list::-webkit-scrollbar {
            width: 8px;
        }

        .chat-messages::-webkit-scrollbar-track,
        .members-list::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
        }

        .chat-messages::-webkit-scrollbar-thumb,
        .members-list::-webkit-scrollbar-thumb {
            background: var(--light-purple);
            border-radius: 4px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover,
        .members-list::-webkit-scrollbar-thumb:hover {
            background: var(--lighter-purple);
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- Members Sidebar -->
        <div class="members-sidebar" id="membersSidebar">
            <div class="sidebar-header">
                <h5><i class="bi bi-people-fill me-2"></i>Online Members</h5>
                <button class="btn-close-sidebar" id="closeSidebar">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>

            <div class="rooms-section">
                <div class="rooms-section-header">
                    <span><i class="bi bi-door-open me-2"></i>Rooms</span>
                    <button class="btn-create-room" id="createRoomBtn">+ New</button>
                </div>
                <div class="rooms-list" id="roomsList">
                    <!-- Rooms will be added here dynamically -->
                </div>
            </div>

            <div class="members-list" id="membersList">
                <!-- Members will be added dynamically -->
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="main-chat-area">
            <!-- Chat Header -->
            <div class="chat-header d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <button class="btn btn-toggle" id="toggleSidebar">
                        <i class="bi bi-list"></i>
                    </button>
                    <h3 id="chatTitle">
                        WebSocket Workshop
                        <span class="online-indicator"></span>
                        <span class="room-indicator" id="roomIndicator" style="display: none;">
                            <i class="bi bi-hash"></i>
                            <span id="currentRoomName"></span>
                        </span>
                    </h3>
                </div>
                <div>
                    <button class="clear-chat-btn" id="clearChatBtn" style="display: none;">
                        <i class="bi bi-trash"></i>
                        Clear Chat
                    </button>
                    <button class="btn btn-toggle" id="showMembers">
                        <i class="bi bi-people-fill"></i>
                        <span class="badge bg-success ms-1" id="online-count">0 online</span>
                    </button>
                </div>
            </div>

            <!-- Chat Messages -->
            <div class="chat-messages" id="messagesContainer">
                <!-- Sample Message -->
                <div class="message">
                    <div class="message-bubble other">
                        <div class="fw-bold mb-1" style="font-size: 0.8rem; color: var(--lighter-purple);">Workshop Bot</div>
                        Welcome to the WebSocket Workshop! Start chatting below.
                    </div>
                    <div class="message-info">2:35 PM</div>
                </div>
            </div>

            <!-- Typing Indicator Above Input (OUTSIDE messages container) -->
            <div class="typing-indicator-container hidden" id="typingIndicatorAboveInput">
                <i class="bi bi-pencil-fill me-2" style="color: var(--lighter-purple);"></i>
                <span class="typing-text" id="typingTextDisplay">Someone is typing</span>
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>

            <!-- Input Container -->
            <div class="chat-input-container">
                <div class="input-group">
                    <input type="text" class="form-control" id="messageInput" placeholder="Type your message..." maxlength="500">
                    <button class="btn btn-send" type="button" id="sendButton">
                        <i class="bi bi-send-fill"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Day.js -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.9/dayjs.min.js"></script>
    <!-- Toastify.js -->
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Day.js -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.9/dayjs.min.js"></script>
    <!-- Toastify.js -->
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <!-- Inline Configuration and Helpers -->
    <script>
      // Toast configuration and helper functions
      const Toast = {
        success: function(message) {
          Toastify({
            text: message,
            duration: 3000,
            gravity: "top",
            position: "right",
            backgroundColor: "var(--lighter-purple)",
            className: "toast-success",
            close: true,
            stopOnFocus: true,
          }).showToast();
        },

        error: function(message) {
          Toastify({
            text: message,
            duration: 10000,
            gravity: "top",
            position: "right",
            backgroundColor: "var(--dark-red)",
            className: "toast-error",
            close: true,
            stopOnFocus: true,
          }).showToast();
        },

        warning: function(message) {
          Toastify({
            text: message,
            duration: 5000,
            gravity: "top",
            position: "right",
            backgroundColor: "var(--orange-brown)",
            className: "toast-warning",
            close: true,
            stopOnFocus: true,
          }).showToast();
        },

        info: function(message) {
          Toastify({
            text: message,
            duration: 3000,
            gravity: "top",
            position: "right",
            backgroundColor: "var(--lighter-purple)",
            className: "toast-info",
            close: true,
            stopOnFocus: true,
          }).showToast();
        }
      };

      // Configuration helper functions
      function getConfig() {
          const config = { ...globalThis.CONFIG };

          // append ?room=some_name to set the room name, convenient for testing
          const urlParams = new URLSearchParams(window.location.search);
          const roomName = urlParams.get('room');
          if (roomName) {
              config.room_name = roomName;
          }
          // append ?username=some_name to set the username, convenient for testing
          const usernameUrl = urlParams.get('username');
          if (usernameUrl) {
              config.username = usernameUrl;
          }
          // NOTE: if using multiple url params, the first one will be prepended with a ?, and the second one a &
          // E.g. localhost:5000?room=some_name&username=some_username

          // Check if username is set
          if (!config.username || config.username.trim() === '') {
              const promptedUsername = prompt('Please enter your username:');
              if (promptedUsername && promptedUsername.trim() !== '') {
                  config.username = promptedUsername.trim();
              } else {
                  alert('Username is required to use the chat application.');
                  return null;
              }
          }

          // Check if backend server address is set
          if (!config.backend_server_address || config.backend_server_address.trim() === '') {
              const promptedAddress = prompt('Please enter the backend server address (e.g., localhost:5000):');
              if (promptedAddress && promptedAddress.trim() !== '') {
                  config.backend_server_address = promptedAddress.trim();
              } else {
                  alert('Backend server address is required to use the chat application.');
                  return null;
              }
          }

          return config;
      }

      function getRestAddress() {
          const suffix = getRoomSuffix();
          if (window.chatConfig.use_https) {
              return `https://${window.chatConfig.backend_server_address}${suffix}`;
          }
          return `http://${window.chatConfig.backend_server_address}${suffix}`;
      }

      function getWsAddress() {
          const suffix = getRoomSuffix();

          if (window.chatConfig.use_https) {
              return `wss://${window.chatConfig.backend_server_address}/ws${suffix}`;
          }
          return `ws://${window.chatConfig.backend_server_address}/ws${suffix}`;
      }

      function getRoomSuffix() {
          if (!window.chatConfig.room_name) {
              return '';
          }
          return `/${window.chatConfig.room_name}`;
      }

      // REST API functions (not used in WebSocket workshop, but included for completeness)
      async function connectUser(serverUrl, username) {
          try {
              const response = await fetch(`${serverUrl}/connect`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ username: username })
              });
              if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
              return await response.json();
          } catch (error) {
              console.error('Error connecting user:', error);
              throw error;
          }
      }

      async function sendMessage(serverUrl, username, message) {
          try {
              const response = await fetch(`${serverUrl}/send-message`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ username: username, message: message })
              });
              if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
              return await response.json();
          } catch (error) {
              Toast.error(`Error sending message: ${error}`);
              console.error('Error sending message:', error);
              throw error;
          }
      }

      async function getAllMessages(serverUrl) {
          try {
              const response = await fetch(`${serverUrl}/messages`);
              if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
              return await response.json();
          } catch (error) {
              Toast.error(`Error getting messages: ${error}`);
              console.error('Error getting messages:', error);
              throw error;
          }
      }

      async function clearChat(serverUrl) {
          try {
              const response = await fetch(`${serverUrl}/clear-chat`, { method: 'DELETE' });
              if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
              return await response.json();
          } catch (error) {
              console.error('Error clearing chat:', error);
              throw error;
          }
      }

      // Export config for use in workshop.js and UI code
      window.getRestAddress = getRestAddress;
      window.getWsAddress = getWsAddress;
    </script>

    <!-- WebSocket Workshop - Student Implementation File -->
    <script src="workshop.js"></script>

    <script>
        window.chatConfig = getConfig();
        if (!window.chatConfig) {
            Toast.error('Configuration failed. Please check your settings.');
        }

        let currentRoom = window.chatConfig.room_name || globalThis.GLOBAL_ROOM_NAME;

        // Try connecting to the server via WebSockets
        wsConnectUser(window.getWsAddress(), window.chatConfig.username);

        // Main chat functionality
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const messagesContainer = document.getElementById('messagesContainer');
        const membersSidebar = document.getElementById('membersSidebar');
        const toggleSidebar = document.getElementById('toggleSidebar');
        const closeSidebar = document.getElementById('closeSidebar');
        const showMembers = document.getElementById('showMembers');
        const membersList = document.getElementById('membersList');

        const roomsList = document.getElementById('roomsList');
        const chatTitle = document.getElementById('chatTitle');
        const roomIndicator = document.getElementById('roomIndicator');
        const currentRoomName = document.getElementById('currentRoomName');
        const clearChatBtn = document.getElementById('clearChatBtn');

        // Typing indicator elements
        const typingIndicatorContainer = document.getElementById('typingIndicatorAboveInput');
        const typingTextDisplay = document.getElementById('typingTextDisplay');

        // Update header based on current room
        function updateHeaderForRoom() {
            if (currentRoom) {
                roomIndicator.style.display = 'inline-flex';
                currentRoomName.textContent = currentRoom;
                clearChatBtn.style.display = 'inline-flex';
            } else {
                roomIndicator.style.display = 'none';
                clearChatBtn.style.display = 'none';
            }
        }

        // Clear chat functionality
        clearChatBtn.addEventListener('click', () => {
            if (currentRoom) {
                console.log(`Clearing chat for room: ${currentRoom}`);
                window.wsSendRoomChatClear(globalThis.websocket, currentRoom);
            }
        });

        // Placeholder function for clearing chat
        function clearChat(roomName) {
            console.log(`clearChat called for room: ${roomName}`);
            // Clear UI
            messagesContainer.innerHTML = '';
            Toast.success(`Chat cleared for room: ${currentRoom}`);
        }

        function checkRoomExists(roomName) {
            const allRooms = roomsList.querySelectorAll('.room-item');
            for (let i = 0; i < allRooms.length; i++) {
                const roomData = allRooms[i].getAttribute('data-room');
                if (roomData === roomName) {
                    return true;
                }
            }
            return false;
        }

        // Add a room to the sidebar
        function addRoomToList(roomName, isActive = false) {
            console.log(`addRoomToList called for room: ${roomName}`);
            if (checkRoomExists(roomName)) {
                console.log(`Room ${roomName} already exists`);
                return;
            }

            const roomDiv = document.createElement('div');
            roomDiv.className = `room-item${isActive ? ' active' : ''}`;
            roomDiv.setAttribute('data-room', roomName);

            const icon = roomName != globalThis.GLOBAL_ROOM_NAME ? 'bi-hash' : 'bi-globe';

            roomDiv.innerHTML = `
                <i class="bi ${icon}"></i>
                <span class="room-name">${roomName}</span>
            `;

            roomDiv.addEventListener('click', () => {
                requestRoomSwitch(roomName);
            });

            roomsList.appendChild(roomDiv);
        }

        function requestRoomSwitch(roomName) {
            if (roomName === currentRoom) {
                Toast.info(`Already in room: ${roomName}`);
                return;
            }

            Toast.info(`Initiating room switch to: ${roomName}`);
            window.wsSendRoomSwitchReq(globalThis.websocket, roomName);
        }

        // Switch to a different room
        function switchToRoom(roomName) {
            const previousRoom = currentRoom;
            currentRoom = roomName;

            // Update UI
            updateRoomActiveState(roomName);
            updateHeaderForRoom();

            // Clear messages
            messagesContainer.innerHTML = '';

            Toast.success(`Switched to room: ${roomName}`);

            // Log for now (will integrate with backend later)
            console.log(`Switching from room "${previousRoom}" to room "${roomName}"`);

            addSystemMessage(`You joined the ${roomName} room`);

            window.chatConfig.room_name = roomName;

            // Close sidebar on mobile
            if (window.innerWidth <= 768) {
                membersSidebar.classList.remove('show');
            }
            scrollToBottom();
        }

        // Update which room is marked as active
        function updateRoomActiveState(roomName) {
            const allRooms = roomsList.querySelectorAll('.room-item');
            allRooms.forEach(room => {
                const roomData = room.getAttribute('data-room');
                if (roomData === roomName) {
                    room.classList.add('active');
                } else {
                    room.classList.remove('active');
                }
            });
        }

        function initializeRooms() {
            // Add global/default room
            addRoomToList(globalThis.GLOBAL_ROOM_NAME, currentRoom === globalThis.GLOBAL_ROOM_NAME);

            // Show toast on initialization
            if (currentRoom) {
                Toast.info(`Connected to room: ${currentRoom}`);
            }
        }

        // Sidebar functionality
        toggleSidebar.addEventListener('click', () => {
            membersSidebar.classList.toggle('show');
        });

        closeSidebar.addEventListener('click', () => {
            membersSidebar.classList.remove('show');
        });

        showMembers.addEventListener('click', () => {
            membersSidebar.classList.toggle('show');
        });

        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', (e) => {
            if (window.innerWidth <= 768 &&
                membersSidebar.classList.contains('show') &&
                !membersSidebar.contains(e.target) &&
                !toggleSidebar.contains(e.target) &&
                !showMembers.contains(e.target)) {
                membersSidebar.classList.remove('show');
            }
        });

        // Send message on Enter key
        messageInput.addEventListener('keypress', function(e) {

            if (messageInput.value.length > 80 && messageInput.value.length % 5 === 0) {
              Toast.warning(`Message might be to long. Current length: ${messageInput.value.length}`);
            }

            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMsg();
            }
        });

        // Send message on button click
        sendButton.addEventListener('click', sendMsg);

        // Create room button click
        document.getElementById('createRoomBtn').addEventListener('click', () => {
            const roomName = prompt('Enter room name:');
            if (roomName && roomName.trim()) {
                console.log('Room name:', roomName.trim());
                Toast.info(`Sending room create request ${roomName.trim()}`);
                window.wsSendRoomCreate(globalThis.websocket, roomName.trim());
            }
        });

        function sendMsg() {
            const message = messageInput.value.trim();
            if (!message) {
                Toast.warning('No message to send.');
                return;
            }

            try {
                if (window.chatConfig.use_rest) {
                    sendMessage(window.getRestAddress(), window.chatConfig.username, message);
                } else {
                    wsSendMessage(globalThis.websocket, message);
                }
                addMessageToUI(message, 'own');
                messageInput.value = '';
            } catch (error) {
                Toast.error(`Error sending message: ${error}`);
            }
            scrollToBottom();
        }

        function addMessageToUI(message, type, username = null, currentTime = dayjs().format('h:mm A')) {
            const shouldScroll = shouldAutoScroll();
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type === 'own' ? 'message-own' : ''}`;

            let messageHTML = '';
            if (type === 'own') {
                messageHTML = `
                    <div class="message-bubble own">
                        ${message}
                    </div>
                    <div class="message-info">${currentTime}</div>
                `;
            } else {
                messageHTML = `
                    <div class="message-bubble other">
                        <div class="fw-bold mb-1" style="font-size: 0.8rem; color: var(--lighter-purple);">${username || 'Anonymous'}</div>
                        ${message}
                    </div>
                    <div class="message-info">${currentTime}</div>
                `;
            }

            messageDiv.innerHTML = messageHTML;
            messagesContainer.appendChild(messageDiv);

            // Add animation
            messageDiv.classList.add('animate__animated', 'animate__fadeInUp');

            // We don't want to scroll to the bottom if the user has manually scrolled up, but when close to the bottom, autoscrolling is probably what the user wants, so let's scroll!
            if (shouldScroll) {
                scrollToBottom();
            }
        }

        function addSystemMessage(message) {
            const systemDiv = document.createElement('div');
            systemDiv.className = 'system-message';
            systemDiv.innerHTML = `<i class="bi bi-info-circle me-1"></i>${message}`;
            messagesContainer.appendChild(systemDiv);
            scrollToBottom();
        }

        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function shouldAutoScroll() {
            const distanceFromBottom =
                        messagesContainer.scrollHeight -
                        messagesContainer.scrollTop -
                        messagesContainer.clientHeight;
            const userIsNearBottom = distanceFromBottom < 280;
            console.log(`Distance from bottom: ${distanceFromBottom}, user is near bottom: ${userIsNearBottom}`);
            return userIsNearBottom;
        }

        // Member list management
        function addMemberToList(username, status = 'online', suffix = "") {
            const memberDiv = document.createElement('div');
            memberDiv.className = 'member-item';
            memberDiv.setAttribute('data-username', username);

            let displayName = username;
            if (suffix) {
                displayName += " " + suffix;
            }

            memberDiv.innerHTML = `
                <i class="bi bi-person-circle me-2"></i>
                <span>${displayName}</span>
                <span class="member-status ${status}">${status}</span>
            `;

            membersList.appendChild(memberDiv);
        }

        function removeMemberFromList(username) {
            const memberItem = membersList.querySelector(`[data-username="${username}"]`);
            if (memberItem) {
                memberItem.remove();
            }
        }

        // Enhanced updateMemberStatus with typing indicator support
        function updateMemberStatus(username, status) {
            const memberItem = membersList.querySelector(`[data-username="${username}"]`);
            if (memberItem) {
                const statusElement = memberItem.querySelector('.member-status');
                statusElement.className = `member-status ${status}`;
                statusElement.textContent = status;
            } else {
                console.log(`Member ${username} not found`);
            }

            // Update the typing indicator above input
            updateTypingIndicatorAboveInput(username, status);
        }

        // Function to update typing indicator above input
        const typingUsersSet = new Set();

        function updateTypingIndicatorAboveInput(username, status) {
            // Don't show typing for self
            if (username === window.chatConfig.username) {
                return;
            }

            if (status === 'typing') {
                typingUsersSet.add(username);
            } else {
                typingUsersSet.delete(username);
            }

            // Update the display
            if (typingUsersSet.size === 0) {
                typingIndicatorContainer.classList.add('hidden');
            } else {
                typingIndicatorContainer.classList.remove('hidden');

                const users = Array.from(typingUsersSet);
                let text = '';

                if (users.length === 1) {
                    text = `${users[0]} is typing`;
                } else if (users.length === 2) {
                    text = `${users[0]} and ${users[1]} are typing`;
                } else if (users.length === 3) {
                    text = `${users[0]}, ${users[1]}, and ${users[2]} are typing`;
                } else {
                    text = `${users[0]}, ${users[1]}, and ${users.length - 2} others are typing`;
                }

                typingTextDisplay.textContent = text;
            }
        }

        function updateOnlineCount() {
            const count = membersList.querySelectorAll('.member-item').length;
            document.getElementById('online-count').textContent = `${count} online`;
        }

        function addSelfAsOnline() {
            // Initialize with current user if config is available
            if (window.chatConfig && window.chatConfig.username) {
                // Clear sample members and add current user
                membersList.innerHTML = '';
                addMemberToList(window.chatConfig.username, 'online', suffix = "(You)");
                updateOnlineCount();
            }
        }

        addSelfAsOnline();
        initializeRooms();
        updateHeaderForRoom();

        document.addEventListener('DOMContentLoaded', async function() {
            scrollToBottom();

            if (!window.chatConfig.use_rest) {
                return;
            }

            const response = await getAllMessages(window.getRestAddress());
            const messages = response.messages;

            messages.forEach((msg, index) => {
                const type = msg.username === window.chatConfig.username ? 'own' : 'other';
                const timestamp = dayjs(msg.timestamp).format('h:mm A');
                addMessageToUI(msg.message, type, msg.username, timestamp);
            });
        });

        // Make functions available globally for WebSocket files
        window.addMessageToUI = addMessageToUI;
        window.addSystemMessage = addSystemMessage;
        window.addMemberToList = addMemberToList;
        window.removeMemberFromList = removeMemberFromList;
        window.updateMemberStatus = updateMemberStatus;
        window.updateOnlineCount = updateOnlineCount;
        window.addRoomToList = addRoomToList;
        window.switchToRoom = switchToRoom;
        window.currentRoom = currentRoom;
        window.clearChat = clearChat;
    </script>
</body>
</html>
